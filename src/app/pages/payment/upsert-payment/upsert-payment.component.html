<nz-modal
  [(nzVisible)]="isVisible"
  nzPlacement="top"
  [nzWidth]="992"
  nzTitle="Tạo phiếu chi"
  [nzContent]="modalContent"
  [nzFooter]="modalFooter"
  (nzOnCancel)="handleCancel()"
  nzMaskClosable="false"
  nzCentered
>
  <ng-template #modalContent>
    <form nz-form [formGroup]="form">
      <div nz-row class="inline">
        <nz-form-item>
          <nz-form-label>Nhóm</nz-form-label>
          <nz-form-control nzErrorTip="Hãy chọn nhóm!">
            <nz-select
              nzShowSearch
              nzAllowClear
              nzPlaceHolder="Chọn nhóm"
              formControlName="groupId"
              (nzOpenChange)="onOpenSelectGroup($event)"
              (ngModelChange)="onChangeSelectGroup($event)"
            >
              <ng-container *ngFor="let g of groups">
                <nz-option
                  *ngIf="!isLoadingGroups"
                  [nzValue]="g.id"
                  [nzLabel]="g.groupName"
                ></nz-option>
              </ng-container>
              <nz-option *ngIf="isLoadingGroups" nzDisabled nzCustomContent>
                <span nz-icon nzType="loading" class="loading-icon"></span>
                Loading...
              </nz-option>
            </nz-select>
          </nz-form-control>
        </nz-form-item>
        <nz-form-item>
          <nz-form-label>Ngày</nz-form-label>
          <nz-form-control nzErrorTip="Hãy chọn ngày!">
            <nz-date-picker
              nzPlaceHolder="Chọn ngày giờ"
              formControlName="date"
            ></nz-date-picker>
          </nz-form-control>
        </nz-form-item>
        <nz-form-item>
          <nz-form-label>Giờ</nz-form-label>
          <nz-form-control>
            <nz-time-picker
              nzFormat="HH:mm"
              [nzMinuteStep]="15"
              nzPlaceHolder="Chọn giờ"
              formControlName="time"
            ></nz-time-picker>
          </nz-form-control>
        </nz-form-item>
      </div>
      <div nz-row nzGutter="xs" [nzGutter]="[16, 16]">
        <div nz-col [nzSpan]="16">
          <nz-card
            nzTitle="Bên A"
            [nzExtra]="aSide_extraTemplate"
            [nzBodyStyle]="{ height: '49vh', 'overflow-y': 'auto' }"
          >
            <nz-spin [nzSpinning]="isAutoLoadASide">
              <ng-container formArrayName="aSide">
                <div
                  nz-row
                  *ngIf="aSideFA.value.length == 0 && aSideFA.touched"
                >
                  <div class="ant-form-item-explain-error">Hãy thêm bên A!</div>
                </div>
                <div
                  nz-row
                  class="inline"
                  *ngFor="let control of aSideFA.controls; let i = index"
                >
                  <ng-container [formGroupName]="i">
                    <nz-form-item class="inline-group">
                      <nz-form-label>{{ i + 1 }}</nz-form-label>
                    </nz-form-item>
                    <nz-form-item>
                      <nz-form-control nzErrorTip="Hãy chọn thành viên!">
                        <nz-select
                          nzShowSearch
                          nzAllowClear
                          nzPlaceHolder="Thành viên"
                          formControlName="userId"
                          (nzOpenChange)="onOpenSelectMember($event)"
                        >
                          <ng-container *ngFor="let m of members">
                            <nz-option
                              *ngIf="!isLoadingMembers"
                              [nzValue]="m.userId"
                              [nzLabel]="m.userName"
                            ></nz-option>
                          </ng-container>
                          <nz-option
                            *ngIf="isLoadingMembers"
                            nzDisabled
                            nzCustomContent
                          >
                            <span
                              nz-icon
                              nzType="loading"
                              class="loading-icon"
                            ></span>
                            Loading...
                          </nz-option>
                        </nz-select>
                      </nz-form-control>
                    </nz-form-item>
                    <nz-form-item>
                      <nz-form-control [nzErrorTip]="amountErrorTpl">
                        <input
                          nz-input
                          placeholder="Số tiền (k VNĐ)"
                          formControlName="amount"
                          [min]="1"
                          [max]="999999"
                        />
                        <ng-template #amountErrorTpl let-control>
                          <ng-container *ngIf="control.hasError('min')">
                            Số tiền tối thiểu là 1 (1k VNĐ)!
                          </ng-container>
                          <ng-container *ngIf="control.hasError('max')">
                            Số tiền tối đa là 999999 (999m VNĐ)!
                          </ng-container>
                          <ng-container *ngIf="control.hasError('required')">
                            Hãy điền số tiền!
                          </ng-container>
                        </ng-template>
                      </nz-form-control>
                    </nz-form-item>
                    <nz-form-item>
                      <nz-form-control nzErrorTip="Hãy điền lý do!">
                        <textarea
                          rows="3"
                          nz-input
                          placeholder="Lý do"
                          formControlName="description"
                        ></textarea>
                      </nz-form-control>
                    </nz-form-item>
                    <nz-form-item>
                      <button
                        nz-button
                        nzType="primary"
                        nzShape="circle"
                        nzSize="small"
                        nzDanger
                        (click)="removeFromASide(i)"
                      >
                        <span nz-icon nzType="minus" nzTheme="outline"></span>
                      </button>
                    </nz-form-item>
                  </ng-container>
                </div>
              </ng-container>
            </nz-spin>
          </nz-card>
          <ng-template #aSide_extraTemplate>
            <div class="inline-group">
              <button
                nz-button
                nzType="primary"
                nzShape="circle"
                nzSize="small"
                (click)="autoLoadASide()"
              >
                <span nz-icon nzType="retweet"></span>
              </button>
              <button
                nz-button
                nzType="primary"
                nzShape="circle"
                nzSize="small"
                (click)="onAddToASide()"
              >
                <span nz-icon nzType="plus"></span>
              </button>
            </div>
          </ng-template>
        </div>
        <div nz-col [nzSpan]="8">
          <nz-card
            nzTitle="Bên B"
            [nzExtra]="bSide_extraTemplate"
            [nzBodyStyle]="{ height: '49vh', 'overflow-y': 'auto' }"
          >
            <nz-spin [nzSpinning]="isAutoLoadBSide">
              <ng-container formArrayName="bSide">
                <div
                  nz-row
                  *ngIf="bSideFA.value.length == 0 && bSideFA.touched"
                >
                  <div class="ant-form-item-explain-error">Hãy thêm bên B!</div>
                </div>
                <div
                  nz-row
                  class="inline"
                  *ngFor="let control of bSideFA.controls; let i = index"
                >
                  <ng-container [formGroupName]="i">
                    <nz-form-item class="inline-group">
                      <nz-form-label>{{ i + 1 }}</nz-form-label>
                    </nz-form-item>
                    <nz-form-item>
                      <nz-form-control nzErrorTip="Hãy chọn thành viên!">
                        <nz-select
                          nzShowSearch
                          nzAllowClear
                          nzPlaceHolder="Thành viên"
                          formControlName="userId"
                          (nzOpenChange)="onOpenSelectMember($event)"
                        >
                          <ng-container *ngFor="let m of members">
                            <nz-option
                              *ngIf="!isLoadingMembers"
                              [nzValue]="m.userId"
                              [nzLabel]="m.userName"
                            ></nz-option>
                          </ng-container>
                          <nz-option
                            *ngIf="isLoadingMembers"
                            nzDisabled
                            nzCustomContent
                          >
                            <span
                              nz-icon
                              nzType="loading"
                              class="loading-icon"
                            ></span>
                            Loading...
                          </nz-option>
                        </nz-select>
                      </nz-form-control>
                    </nz-form-item>
                    <nz-form-item>
                      <button
                        nz-button
                        nzType="primary"
                        nzShape="circle"
                        nzSize="small"
                        nzDanger
                        (click)="removeFromBSide(i)"
                      >
                        <span nz-icon nzType="minus" nzTheme="outline"></span>
                      </button>
                    </nz-form-item>
                  </ng-container>
                </div>
              </ng-container>
            </nz-spin>
          </nz-card>
          <ng-template #bSide_extraTemplate>
            <div class="inline-group">
              <button
                nz-button
                nzType="primary"
                nzShape="circle"
                nzSize="small"
                (click)="autoLoadBSide()"
              >
                <span nz-icon nzType="retweet"></span>
              </button>
              <button
                nz-button
                nzType="primary"
                nzShape="circle"
                nzSize="small"
                (click)="onAddToBSide()"
              >
                <span nz-icon nzType="plus"></span>
              </button>
            </div>
          </ng-template>
        </div>
      </div>
    </form>
  </ng-template>

  <ng-template #modalFooter>
    <button nz-button nzType="primary" nzDanger (click)="onResetForm()">
      Xóa trắng
    </button>
    <button nz-button nzType="primary">Lưu nháp</button>
    <button
      nz-button
      nzType="primary"
      (click)="onGeneratePayment()"
      [nzLoading]="isLoadingPdf"
    >
      Tạo phiếu
    </button>
  </ng-template>
</nz-modal>

<gmm-pdf-viewer
  [(visible)]="isVisiblePdf"
  [dataObjUrl]="pdfObjUrl"
  [isUnderModal]="false"
  title="Payment Slip"
>
  <ng-container buttons>
    <button
      nz-button
      nzType="primary"
      (click)="onSavePayment()"
      [nzLoading]="isSavingPayment"
    >
      Đồng ý
    </button>
  </ng-container>
</gmm-pdf-viewer>
